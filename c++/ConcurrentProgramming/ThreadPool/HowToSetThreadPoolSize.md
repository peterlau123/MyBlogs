### 如何正确设计线程池的大小

线程池大小的设置是一个值得注意的事项，过大或过小都不能得到最佳性能。过大可能会导致许多线程空闲导致资源浪费，若线程数量超过硬件的原生支持数量，则会损失性能；

若过小，又会使得其他任务等待时间过长，若线程小于硬件的支持数量，则又不能充分发挥硬件的优势。虽然，我们可以使用std::hardware_concurrency()获取

硬件原生的线程支持数量，但并不能从根本很好的解决这个问题，只不过避免了手工设置线程数量而已。



在此，我们先引入一个概念**Little Law**

![Java-Perf-Tuning](https://tva1.sinaimg.cn/large/008i3skNgy1gqo8t6lfluj311c0u0neh.jpg)

比如系统每单位时间接收10个任务，每个任务的完成时间是2个时间单位，这个时间单位可以是ms或s。那么每个单位时间，系统会存在20个任务，这个时候最佳的情况是，系统可以启动20个线程来处理这20个任务。由于硬件本身也有支持的线程数量**N**，我们要做的就是既要能最大化利用硬件资源，又不能使得太多任务在等待中。

可知，如果**L**接近**N**时，上面两点要求我们是可以兼顾的。若**L**远小于**N**，那么线程池大小设置为**L**即可；若**L**接近于**N**，那么设置为**N**；若**L**远大于**N**，那么就要考虑增加机器了。

通过以上分析，**Little's Law**可以给我们一些优化的指导，但具体地，我们要根据实际业务场景，通过测试选择最佳的线程数量。



#### 参考资料

1. [Java-Perf_tuning](https://www.infoq.com/articles/Java-Thread-Pool-Performance-Tuning/)


